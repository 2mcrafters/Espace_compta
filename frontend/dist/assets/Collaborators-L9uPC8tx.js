import{e as v,R as x,j as e,d as g,M as y}from"./index-6jc1YW1i.js";import{u as p}from"./useQuery-SKqCO6Ti.js";import{u as j}from"./useMutation-ClYfTwts.js";import{B as u}from"./Button-DWzqGaEt.js";import{I as i}from"./Input-D8FRziaI.js";import{R as N}from"./RequirePermission-Dz9kGamF.js";function b(){return p({queryKey:["users"],queryFn:async()=>(await g.get("/users")).data})}function _(a){return p({queryKey:["user-stats",a],queryFn:async()=>(await g.get(`/users/${a}/stats`)).data,enabled:!!a})}function k(){const a=v(),{data:o=[],isLoading:c}=b(),[r,n]=x.useState(null),[d,l]=x.useState(null),m=j({mutationFn:async({id:s,...h})=>(await g.put(`/users/${s}`,h)).data,onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),n(null)}}),t=j({mutationFn:async({id:s,hourly_rate_mad:h,effective_from:f})=>(await g.post(`/users/${s}/rate`,{hourly_rate_mad:h,effective_from:f})).data,onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),l(null)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Collaborateurs"}),c?e.jsx("p",{children:"Chargement..."}):e.jsx("div",{className:"bg-white rounded-xl border p-4",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-sm text-gray-600",children:[e.jsx("th",{className:"py-2",children:"Nom"}),e.jsx("th",{className:"py-2",children:"Fonction"}),e.jsx("th",{className:"py-2",children:"Email"}),e.jsx("th",{className:"py-2",children:"Téléphone"}),e.jsx("th",{className:"py-2",children:"Objectif mensuel"}),e.jsx("th",{className:"py-2",children:"Taux horaire"}),e.jsx("th",{className:"py-2 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y",children:o.map(s=>e.jsx(C,{user:s,onEdit:()=>n(s),onSetRate:()=>l(s)},s.id))})]})}),r&&e.jsx(S,{user:r,onClose:()=>n(null),onSave:s=>m.mutate(s),saving:m.isPending}),d&&e.jsx(M,{user:d,onClose:()=>l(null),onSave:s=>t.mutate(s),saving:t.isPending})]})}function C({user:a,onEdit:o,onSetRate:c}){const{data:r}=_(a.id);return e.jsxs("tr",{children:[e.jsxs("td",{className:"py-2",children:[e.jsx("div",{className:"font-medium text-gray-900",children:a.first_name||a.last_name?`${a.first_name||""} ${a.last_name||""}`.trim():a.name}),e.jsx("div",{className:"text-xs text-gray-500",children:a.internal_id||"—"})]}),e.jsx("td",{className:"py-2",children:a.job_title||"—"}),e.jsx("td",{className:"py-2",children:a.email}),e.jsx("td",{className:"py-2",children:a.phone||"—"}),e.jsxs("td",{className:"py-2",children:[a.monthly_hours_target||"—"," h"]}),e.jsx("td",{className:"py-2",children:a.hourly_rate_mad?`${Number(a.hourly_rate_mad).toFixed(2)} MAD`:"—"}),e.jsxs("td",{className:"py-2 text-right",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(u,{onClick:o,className:"!from-gray-600 !to-gray-700",children:"Modifier"}),e.jsx(N,{perm:"users.rate",fallback:null,children:e.jsx(u,{onClick:c,className:"!from-indigo-500 !to-indigo-600",children:"Taux horaire"})})]}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:["Ce mois: ",(r==null?void 0:r.minutes_month)??"—"," min · Cette année: ",(r==null?void 0:r.minutes_year)??"—"," min"]})]})]})}function S({user:a,onClose:o,onSave:c,saving:r}){const[n,d]=x.useState({...a});function l(t,s){d(h=>({...h,[t]:s}))}function m(){c({id:a.id,...n})}return e.jsx(y,{open:!0,onClose:o,title:`Modifier ${a.name}`,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{onClick:o,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(u,{onClick:m,disabled:r,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(i,{label:"Prénom",value:n.first_name||"",onChange:t=>l("first_name",t.target.value)}),e.jsx(i,{label:"Nom",value:n.last_name||"",onChange:t=>l("last_name",t.target.value)}),e.jsx(i,{label:"Email",value:n.email||"",onChange:t=>l("email",t.target.value)}),e.jsx(i,{label:"Téléphone",value:n.phone||"",onChange:t=>l("phone",t.target.value)}),e.jsx(i,{label:"Identifiant interne",value:n.internal_id||"",onChange:t=>l("internal_id",t.target.value)}),e.jsx(i,{label:"Fonction",value:n.job_title||"",onChange:t=>l("job_title",t.target.value)}),e.jsx(i,{label:"Objectif mensuel (h)",type:"number",step:"0.01",value:n.monthly_hours_target||"",onChange:t=>l("monthly_hours_target",t.target.value)}),e.jsx(i,{label:"Objectif annuel (h)",type:"number",step:"0.01",value:n.yearly_hours_target||"",onChange:t=>l("yearly_hours_target",t.target.value)})]})})}function M({user:a,onClose:o,onSave:c,saving:r}){const[n,d]=x.useState(""),[l,m]=x.useState(new Date().toISOString().slice(0,10));function t(){c({id:a.id,hourly_rate_mad:Number(n),effective_from:l})}return e.jsx(y,{open:!0,onClose:o,title:`Taux horaire • ${a.name}`,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{onClick:o,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(u,{onClick:t,disabled:r||!n,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(i,{label:"Taux (MAD/h)",type:"number",step:"0.01",value:n,onChange:s=>d(s.target.value)}),e.jsx(i,{label:"Date d'effet",type:"date",value:l,onChange:s=>m(s.target.value)}),e.jsx("p",{className:"text-sm text-gray-500 md:col-span-2",children:"Seuls les rôles autorisés peuvent consulter/modifier le taux horaire."})]})})}export{k as default};
