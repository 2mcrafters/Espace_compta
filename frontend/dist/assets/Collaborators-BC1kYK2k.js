import{e as E,R as b,j as e,m as j,d as N,M as k}from"./index-DrS59qMr.js";import{u as S}from"./useQuery-DxNF-Ufy.js";import{u as C}from"./useMutation-BqWX8doi.js";import{B as v}from"./Button-zGB7KR70.js";import{I as o}from"./Input-BV1IA8MG.js";import{R as w}from"./RequirePermission-EK-aUSRO.js";function q(){return S({queryKey:["users"],queryFn:async()=>{try{return(await N.get("/users")).data}catch(a){throw console.error("Error fetching users:",a),a}}})}function F(a){return S({queryKey:["user-stats",a],queryFn:async()=>{var c;try{return(await N.get(`/users/${a}/stats`)).data}catch(s){if(((c=s.response)==null?void 0:c.status)===403)return null;throw s}},enabled:!!a,retry:!1})}function P(){var i,f;const a=E(),{data:c=[],isLoading:s,error:h}=q(),[l,u]=b.useState(null),[r,p]=b.useState(null),[n,m]=b.useState(!1),y=C({mutationFn:async({id:d,...x})=>{try{return(await N.put(`/users/${d}`,x)).data}catch(g){throw console.error("Error saving user:",g),g}},onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),u(null)},onError:d=>{var x,g;alert(`Erreur: ${((g=(x=d.response)==null?void 0:x.data)==null?void 0:g.message)||d.message||"Impossible de sauvegarder"}`)}}),t=C({mutationFn:async({id:d,hourly_rate_mad:x,effective_from:g})=>{try{return(await N.post(`/users/${d}/rate`,{hourly_rate_mad:x,effective_from:g})).data}catch(_){throw console.error("Error setting rate:",_),_}},onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),a.invalidateQueries({queryKey:["user-stats"]}),p(null)},onError:d=>{var g,_,M;const x=((g=d.response)==null?void 0:g.status)===403?"Vous n'avez pas la permission de modifier les taux horaires":((M=(_=d.response)==null?void 0:_.data)==null?void 0:M.message)||d.message||"Impossible de définir le taux";alert(`Erreur: ${x}`)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(j.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},children:e.jsxs("div",{className:"flex items-end justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent mb-2",children:"Collaborateurs"}),e.jsx("p",{className:"text-gray-600",children:"Gérez vos collaborateurs et leurs informations"})]}),e.jsx(w,{perm:"users.edit",fallback:null,children:e.jsxs(v,{onClick:()=>m(!0),children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Nouvel utilisateur"]})})]})}),h&&e.jsxs(j.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl",children:[e.jsx("p",{className:"font-medium",children:"Erreur de chargement"}),e.jsx("p",{className:"text-sm",children:((f=(i=h.response)==null?void 0:i.data)==null?void 0:f.message)||h.message||"Impossible de charger les collaborateurs"})]}),s?e.jsx("div",{className:"space-y-3",children:Array.from({length:4}).map((d,x)=>e.jsx(j.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:x*.05},className:"h-20 bg-gray-200 rounded-xl animate-pulse"},x))}):e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200",children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Nom"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Fonction"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Téléphone"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Objectif mensuel"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Taux horaire"}),e.jsx("th",{className:"px-6 py-4 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:c.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-gray-400",children:[e.jsx("svg",{className:"w-16 h-16 mb-3 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsx("p",{className:"font-medium",children:"Aucun collaborateur"})]})})}):c.map((d,x)=>e.jsx(R,{user:d,index:x,onEdit:()=>u(d),onSetRate:()=>p(d)},d.id))})]})})}),l&&e.jsx($,{user:l,onClose:()=>u(null),onSave:d=>y.mutate(d),saving:y.isPending}),r&&e.jsx(T,{user:r,onClose:()=>p(null),onSave:d=>t.mutate(d),saving:t.isPending}),n&&e.jsx(A,{onClose:()=>m(!1),onCreated:()=>{a.invalidateQueries({queryKey:["users"]}),m(!1)}})]})}function R({user:a,index:c,onEdit:s,onSetRate:h}){var p,n,m,y;const{data:l,error:u}=F(a.id),r=!u||((p=u==null?void 0:u.response)==null?void 0:p.status)!==403;return e.jsxs(j.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:c*.05},whileHover:{backgroundColor:"rgba(243, 244, 246, 0.8)",scale:1.005,boxShadow:"0 4px 20px rgba(0, 0, 0, 0.05)"},className:"transition-all duration-300 relative group",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-700 flex items-center justify-center text-white font-bold mr-3 shadow-lg",children:(((n=a.first_name)==null?void 0:n[0])||((m=a.last_name)==null?void 0:m[0])||((y=a.name)==null?void 0:y[0])||"U").toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:a.first_name||a.last_name?`${a.first_name||""} ${a.last_name||""}`.trim():a.name}),e.jsx("div",{className:"text-xs text-gray-500",children:a.internal_id||"—"})]})]})}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:a.job_title||"—"}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:a.email}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:a.phone||"—"}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-700",children:[a.monthly_hours_target||"—"," h"]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(w,{perm:"users.rate",fallback:e.jsx("span",{className:"text-gray-400 text-sm",children:"•••"}),children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-700",children:a.hourly_rate_mad?`${Number(a.hourly_rate_mad).toFixed(2)} MAD`:"—"})})}),e.jsxs("td",{className:"px-6 py-4 text-right",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(w,{perm:"users.edit",fallback:null,children:e.jsxs(j.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(75, 85, 99, 0.4)"},whileTap:{scale:.95},onClick:s,className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Modifier"})]})}),e.jsx(w,{perm:"users.rate",fallback:null,children:e.jsxs(j.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(99, 102, 241, 0.4)"},whileTap:{scale:.95},onClick:h,className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Taux horaire"})]})})]}),r&&e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["Ce mois: ",(l==null?void 0:l.minutes_month)??"0"," min · Cette année:"," ",(l==null?void 0:l.minutes_year)??"0"," min"]})]})]})}function $({user:a,onClose:c,onSave:s,saving:h}){const[l,u]=b.useState({...a});function r(n,m){u(y=>({...y,[n]:m}))}function p(){s({id:a.id,...l})}return e.jsx(k,{open:!0,onClose:c,title:`Modifier ${a.name}`,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{onClick:c,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(v,{onClick:p,disabled:h,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(o,{label:"Prénom",value:l.first_name||"",onChange:n=>r("first_name",n.target.value)}),e.jsx(o,{label:"Nom",value:l.last_name||"",onChange:n=>r("last_name",n.target.value)}),e.jsx(o,{label:"Email",value:l.email||"",onChange:n=>r("email",n.target.value)}),e.jsx(o,{label:"Téléphone",value:l.phone||"",onChange:n=>r("phone",n.target.value)}),e.jsx(o,{label:"Identifiant interne",value:l.internal_id||"",onChange:n=>r("internal_id",n.target.value)}),e.jsx(o,{label:"Fonction",value:l.job_title||"",onChange:n=>r("job_title",n.target.value)}),e.jsx(o,{label:"Objectif mensuel (h)",type:"number",step:"0.01",value:l.monthly_hours_target||"",onChange:n=>r("monthly_hours_target",n.target.value)}),e.jsx(o,{label:"Objectif annuel (h)",type:"number",step:"0.01",value:l.yearly_hours_target||"",onChange:n=>r("yearly_hours_target",n.target.value)})]})})}function T({user:a,onClose:c,onSave:s,saving:h}){const[l,u]=b.useState(""),[r,p]=b.useState(new Date().toISOString().slice(0,10));function n(){s({id:a.id,hourly_rate_mad:Number(l),effective_from:r})}return e.jsx(k,{open:!0,onClose:c,title:`Taux horaire • ${a.name}`,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{onClick:c,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(v,{onClick:n,disabled:h||!l,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(o,{label:"Taux (MAD/h)",type:"number",step:"0.01",value:l,onChange:m=>u(m.target.value)}),e.jsx(o,{label:"Date d'effet",type:"date",value:r,onChange:m=>p(m.target.value)}),e.jsx("p",{className:"text-sm text-gray-500 md:col-span-2",children:"Seuls les rôles autorisés peuvent consulter/modifier le taux horaire."})]})})}function A({onClose:a,onCreated:c}){var y;E();const[s,h]=b.useState({first_name:"",last_name:"",email:"",phone:"",internal_id:"",job_title:"",monthly_hours_target:"",yearly_hours_target:"",password:"",roles:[],hourly_rate_mad:"",hourly_rate_effective_from:new Date().toISOString().slice(0,10)}),{data:l}=S({queryKey:["roles-permissions"],queryFn:async()=>(await N.get("/roles-permissions")).data}),u=C({mutationFn:async t=>{const{data:i}=await N.post("/users",t);return i},onSuccess:()=>{c==null||c()},onError:t=>{var i,f;alert(`Erreur: ${((f=(i=t.response)==null?void 0:i.data)==null?void 0:f.message)||t.message||"Impossible de créer l'utilisateur"}`)}});function r(t,i){h(f=>({...f,[t]:i}))}function p(t){h(i=>({...i,roles:i.roles.includes(t)?i.roles.filter(f=>f!==t):[...i.roles,t]}))}function n(t){t.preventDefault();const i={...s};i.monthly_hours_target=i.monthly_hours_target===""?null:Number(i.monthly_hours_target),i.yearly_hours_target=i.yearly_hours_target===""?null:Number(i.yearly_hours_target),i.hourly_rate_mad===""&&delete i.hourly_rate_mad,u.mutate(i)}const m=((y=l==null?void 0:l.roles)==null?void 0:y.map(t=>t.name))??[];return e.jsx(k,{open:!0,onClose:a,title:"Créer un utilisateur",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{onClick:a,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(v,{onClick:n,disabled:u.isPending||!s.email||!s.password,children:"Créer"})]}),children:e.jsxs("form",{onSubmit:n,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(o,{label:"Prénom",value:s.first_name,onChange:t=>r("first_name",t.target.value)}),e.jsx(o,{label:"Nom",value:s.last_name,onChange:t=>r("last_name",t.target.value)}),e.jsx(o,{label:"Email",type:"email",value:s.email,onChange:t=>r("email",t.target.value),required:!0}),e.jsx(o,{label:"Mot de passe",type:"password",value:s.password,onChange:t=>r("password",t.target.value),required:!0}),e.jsx(o,{label:"Téléphone",value:s.phone,onChange:t=>r("phone",t.target.value)}),e.jsx(o,{label:"Identifiant interne",value:s.internal_id,onChange:t=>r("internal_id",t.target.value)}),e.jsx(o,{label:"Fonction",value:s.job_title,onChange:t=>r("job_title",t.target.value)}),e.jsx(o,{label:"Objectif mensuel (h)",type:"number",step:"0.01",value:s.monthly_hours_target,onChange:t=>r("monthly_hours_target",t.target.value)}),e.jsx(o,{label:"Objectif annuel (h)",type:"number",step:"0.01",value:s.yearly_hours_target,onChange:t=>r("yearly_hours_target",t.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(o,{label:"Taux (MAD/h)",type:"number",step:"0.01",value:s.hourly_rate_mad,onChange:t=>r("hourly_rate_mad",t.target.value)}),e.jsx(o,{label:"Date d'effet",type:"date",value:s.hourly_rate_effective_from,onChange:t=>r("hourly_rate_effective_from",t.target.value)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rôles"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:m.length===0?e.jsx("span",{className:"text-sm text-gray-500",children:"Chargement des rôles..."}):m.map(t=>e.jsx("button",{type:"button",onClick:()=>p(t),className:`px-3 py-1 rounded-full text-sm border ${s.roles.includes(t)?"bg-primary-600 text-white border-primary-600":"bg-white text-gray-700 border-gray-300"}`,children:t},t))})]})]})})}export{P as default};
