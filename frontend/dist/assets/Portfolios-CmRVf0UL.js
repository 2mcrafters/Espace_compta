import{e as C,R as x,j as e,m as F,M as v,C as w,d as o}from"./index-6jc1YW1i.js";import{u as p}from"./useQuery-SKqCO6Ti.js";import{u as y}from"./useMutation-ClYfTwts.js";import{B as i}from"./Button-DWzqGaEt.js";import{I as g}from"./Input-D8FRziaI.js";import{R as N}from"./RequirePermission-Dz9kGamF.js";function M(){return p({queryKey:["portfolios"],queryFn:async()=>{const{data:s}=await o.get("/portfolios");return s}})}function A(){const s=C(),{data:h=[],isLoading:m}=M(),[j,d]=x.useState(!1),[l,r]=x.useState(null),[f,c]=x.useState(null),[n,a]=x.useState(null),b=y({mutationFn:async t=>{if(t.id){const{id:u,...q}=t,{data:S}=await o.put(`/portfolios/${u}`,q);return S}else{const{data:u}=await o.post("/portfolios",t);return u}},onSuccess:()=>{s.invalidateQueries({queryKey:["portfolios"]}),d(!1),r(null)}}),k=y({mutationFn:async t=>{await o.delete(`/portfolios/${t}`)},onSuccess:()=>{s.invalidateQueries({queryKey:["portfolios"]}),a(null)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Portefeuilles"}),e.jsx(N,{perm:"clients.edit",fallback:null,children:e.jsx(i,{onClick:()=>{r({name:"",description:""}),d(!0)},children:"Nouveau portefeuille"})})]}),m?e.jsx("p",{children:"Chargement..."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:h.map(t=>e.jsxs(F.div,{className:"bg-white border rounded-xl p-4 shadow-sm",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500",children:t.description||"—"})]}),e.jsxs("span",{className:"text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded",children:[t.clients_count," clients"]})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx(i,{onClick:()=>{r(t),d(!0)},className:"!from-gray-600 !to-gray-700",children:"Modifier"}),e.jsx(i,{onClick:()=>c(t),className:"!from-blue-500 !to-blue-600",children:"Collaborateurs"}),e.jsx(N,{perm:"clients.edit",fallback:null,children:e.jsx(i,{onClick:()=>a(t),className:"!from-red-500 !to-red-600",children:"Supprimer"})})]})]},t.id))}),e.jsx(v,{open:j,onClose:()=>{d(!1),r(null)},title:l!=null&&l.id?"Modifier le portefeuille":"Nouveau portefeuille",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(i,{onClick:()=>d(!1),className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(i,{onClick:()=>b.mutate(l),disabled:b.isPending,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(g,{label:"Nom",value:(l==null?void 0:l.name)||"",onChange:t=>r(u=>({...u,name:t.target.value}))}),e.jsx(g,{label:"Description",value:(l==null?void 0:l.description)||"",onChange:t=>r(u=>({...u,description:t.target.value}))})]})}),e.jsx($,{portfolio:f,onClose:()=>c(null)}),e.jsx(w,{open:!!n,title:"Supprimer le portefeuille",description:n?`Confirmez la suppression de "${n.name}". Les rattachements clients seront détachés.`:"",onCancel:()=>a(null),onConfirm:()=>n&&k.mutate(n.id)})]})}function $({portfolio:s,onClose:h}){const m=!!s,j=C(),{data:d=[]}=p({queryKey:["users-lookup"],queryFn:async()=>(await o.get("/users/lookup")).data,enabled:m}),{data:l=[]}=p({queryKey:["portfolio-collabs",s==null?void 0:s.id],queryFn:async()=>(await o.get(`/portfolios/${s.id}/collaborators`)).data,enabled:m}),r=y({mutationFn:async a=>(await o.post(`/portfolios/${s.id}/collaborators`,{user_id:a})).data,onSuccess:()=>j.invalidateQueries({queryKey:["portfolio-collabs",s==null?void 0:s.id]})}),f=y({mutationFn:async a=>(await o.delete(`/portfolios/${s.id}/collaborators/${a}`)).data,onSuccess:()=>j.invalidateQueries({queryKey:["portfolio-collabs",s==null?void 0:s.id]})}),[c,n]=x.useState(null);return e.jsxs(v,{open:m,onClose:h,title:s?`Collaborateurs • ${s.name}`:"Collaborateurs",footer:e.jsx("div",{className:"flex gap-2",children:e.jsx(i,{onClick:h,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Fermer"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Tous les utilisateurs"}),e.jsx("ul",{className:"divide-y",children:d.map(a=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("span",{children:[a.name," ",e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",a.email,")"]})]}),e.jsx(i,{onClick:()=>r.mutate(a.id),className:"!from-blue-500 !to-blue-600",children:"Ajouter"})]},a.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Collaborateurs du portefeuille"}),e.jsx("ul",{className:"divide-y",children:l.map(a=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("span",{children:[a.name," ",e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",a.email,")"]})]}),e.jsx(i,{onClick:()=>n(a),className:"!from-red-500 !to-red-600",children:"Retirer"})]},a.id))})]})]}),e.jsx(w,{open:!!c,title:"Retirer le collaborateur",description:c?`Retirer ${c.name} de ${s==null?void 0:s.name} ?`:"",onCancel:()=>n(null),onConfirm:()=>{c&&(f.mutate(c.id),n(null))}})]})}export{A as default};
