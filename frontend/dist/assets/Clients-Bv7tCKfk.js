import{e as D,b as H,f as K,R as x,j as e,m as b,C as T,M as R,d as y}from"./index-6jc1YW1i.js";import{u as M}from"./useQuery-SKqCO6Ti.js";import{u as k}from"./useMutation-ClYfTwts.js";import{B as C}from"./Button-DWzqGaEt.js";import{I as d}from"./Input-D8FRziaI.js";import{R as q}from"./RequirePermission-Dz9kGamF.js";function Q(){return M({queryKey:["clients"],queryFn:async()=>{const{data:a}=await y.get("/clients");return(a==null?void 0:a.data)??a}})}function z(){return M({queryKey:["portfolios"],queryFn:async()=>{const{data:a}=await y.get("/portfolios");return a}})}function V(){const a=D(),p=H(K),{data:u=[],isLoading:j}=Q(),{data:h=[]}=z(),[m,g]=x.useState(!1),[i,c]=x.useState(null),[s,l]=x.useState(null),[_,t]=x.useState(null),[S,N]=x.useState(null),F=k({mutationFn:async r=>{const o={...r};if(typeof o.associes=="string"&&o.associes.trim()!=="")try{o.associes=JSON.parse(o.associes)}catch{}if(o.montant_contrat!==void 0&&o.montant_contrat!==""&&(o.montant_contrat=Number(o.montant_contrat)),o.capital_social!==void 0&&o.capital_social!==""&&(o.capital_social=Number(o.capital_social)),r.id){const{id:f,...w}=o,{data:E}=await y.put(`/clients/${f}`,w);return E}else{const{data:f}=await y.post("/clients",o);return f}},onSuccess:()=>{a.invalidateQueries({queryKey:["clients"]}),g(!1),c(null)}}),$=k({mutationFn:async r=>{await y.delete(`/clients/${r}`)},onSuccess:()=>{a.invalidateQueries({queryKey:["clients"]}),l(null)}});function A(){var r;c({portfolio_id:((r=h==null?void 0:h[0])==null?void 0:r.id)||"",raison_sociale:"",email:"",telephone:"",montant_contrat:"",adresse:"",forme_juridique:"",statut_juridique:"",date_creation:"",capital_social:"",associes:"",regime_fiscal:"",date_debut_collaboration:"",responsable_client:"",type_mission:""}),g(!0)}function n(r){c({...r,associes:Array.isArray(r.associes)?JSON.stringify(r.associes):r.associes??""}),g(!0)}const v=!!p&&Array.isArray(p.roles)&&p.roles.some(r=>["ADMIN","CHEF_EQUIPE"].includes(r));return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(b.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent mb-2",children:"Clients"}),e.jsx("p",{className:"text-gray-600",children:"Gérez vos clients et leurs informations"})]}),e.jsx(q,{perm:"clients.edit",fallback:null,children:e.jsxs(C,{onClick:A,className:"!from-primary-500 !to-primary-700",children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Ajouter un client"]})})]}),j?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((r,o)=>e.jsx(b.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:o*.05},className:"h-16 bg-gray-200 rounded-xl animate-pulse"},o))}):e.jsx(b.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200",children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Raison sociale"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Telephone"}),v&&e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Montant contrat"}),e.jsx("th",{className:"px-6 py-4 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:u.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:v?5:4,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-gray-400",children:[e.jsx("svg",{className:"w-16 h-16 mb-3 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsx("p",{className:"font-medium",children:"Aucun client"}),e.jsx("p",{className:"text-sm",children:'Cliquez sur "Ajouter un client" pour commencer'})]})})}):u.map((r,o)=>{var f,w;return e.jsxs(b.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:o*.05},whileHover:{backgroundColor:"rgba(243, 244, 246, 0.5)"},className:"transition-colors",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-700 flex items-center justify-center text-white font-bold mr-3 shadow-lg",children:((w=(f=r.raison_sociale)==null?void 0:f.charAt(0))==null?void 0:w.toUpperCase())||"C"}),e.jsx("div",{className:"font-medium text-gray-900",children:r.raison_sociale})]})}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:r.email||"—"}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:r.telephone||"—"}),v&&e.jsx("td",{className:"px-6 py-4",children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-700",children:r.montant_contrat?`${parseFloat(r.montant_contrat).toLocaleString()} €`:"—"})}),e.jsx("td",{className:"px-6 py-4 text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsxs(b.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(59, 130, 246, 0.35)"},whileTap:{scale:.95},onClick:()=>t(r),className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Documents"})]}),e.jsxs(q,{perm:"clients.edit",fallback:null,children:[e.jsxs(b.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(59, 130, 246, 0.35)"},whileTap:{scale:.95},onClick:()=>N(r),className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Collaborateurs"})]}),e.jsx(q,{perm:"clients.edit",fallback:null,children:e.jsxs(b.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(75, 85, 99, 0.4)"},whileTap:{scale:.95},onClick:()=>n(r),className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Modifier"})]})})]}),e.jsx(q,{perm:"clients.edit",fallback:null,children:e.jsxs(b.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(239, 68, 68, 0.4)"},whileTap:{scale:.95},onClick:()=>l(r),className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Supprimer"})]})})]})})]},r.id)})})]})})}),e.jsx(L,{open:m,onClose:()=>{g(!1),c(null)},portfolios:h,client:i,onSubmit:r=>F.mutate(r),saving:F.isPending}),e.jsx(T,{open:!!s,title:"Supprimer le client",description:`Êtes-vous sûr de vouloir supprimer ${s==null?void 0:s.raison_sociale} ?`,onCancel:()=>l(null),onConfirm:()=>$.mutate(s.id)}),e.jsx(B,{client:_,onClose:()=>t(null)}),e.jsx(I,{client:S,onClose:()=>N(null)})]})}function I({client:a,onClose:p}){const u=!!a,j=D(),{data:h=[]}=M({queryKey:["users-lookup"],queryFn:async()=>(await y.get("/users/lookup")).data,enabled:u}),{data:m=[]}=M({queryKey:["client-collabs",a==null?void 0:a.id],queryFn:async()=>(await y.get(`/clients/${a.id}/collaborators`)).data,enabled:u}),g=k({mutationFn:async l=>(await y.post(`/clients/${a.id}/collaborators`,{user_id:l})).data,onSuccess:()=>j.invalidateQueries({queryKey:["client-collabs",a==null?void 0:a.id]})}),i=k({mutationFn:async l=>(await y.delete(`/clients/${a.id}/collaborators/${l}`)).data,onSuccess:()=>j.invalidateQueries({queryKey:["client-collabs",a==null?void 0:a.id]})}),[c,s]=x.useState(null);return e.jsxs(R,{open:u,onClose:p,title:a?`Collaborateurs • ${a.raison_sociale}`:"Collaborateurs",footer:e.jsx("div",{className:"flex gap-2",children:e.jsx(C,{onClick:p,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Fermer"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Tous les utilisateurs"}),e.jsx("ul",{className:"divide-y",children:h.map(l=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("span",{children:[l.name," ",e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",l.email,")"]})]}),e.jsx(C,{onClick:()=>g.mutate(l.id),className:"!from-blue-500 !to-blue-600",children:"Ajouter"})]},l.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2",children:"Collaborateurs du client"}),e.jsx("ul",{className:"divide-y",children:m.map(l=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("span",{children:[l.name," ",e.jsxs("span",{className:"text-gray-500 text-xs",children:["(",l.email,")"]})]}),e.jsx(C,{onClick:()=>s(l),className:"!from-red-500 !to-red-600",children:"Retirer"})]},l.id))})]})]}),e.jsx(T,{open:!!c,title:"Retirer le collaborateur",description:c?`Retirer ${c.name} du client ${a==null?void 0:a.raison_sociale} ?`:"",onCancel:()=>s(null),onConfirm:()=>{c&&(i.mutate(c.id),s(null))}})]})}function L({open:a,onClose:p,client:u,onSubmit:j,saving:h,portfolios:m=[]}){var _;const g={portfolio_id:((_=m==null?void 0:m[0])==null?void 0:_.id)||"",raison_sociale:"",email:"",telephone:"",montant_contrat:"",adresse:"",forme_juridique:"",statut_juridique:"",date_creation:"",capital_social:"",associes:"",regime_fiscal:"",date_debut_collaboration:"",responsable_client:"",type_mission:"",rc:"",if:"",ice:""},[i,c]=x.useState(u||g);x.useEffect(()=>{c(u||g)},[u,m]);function s(t,S){c(N=>({...N,[t]:S}))}function l(t){t.preventDefault(),j==null||j(i)}return e.jsx(R,{open:a,onClose:p,title:u!=null&&u.id?"Modifier le client":"Ajouter un client",footer:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(b.button,{whileHover:{scale:1.03,borderColor:"rgb(156, 163, 175)",boxShadow:"0 4px 12px rgba(0, 0, 0, 0.1)"},whileTap:{scale:.97},className:"px-5 py-2.5 rounded-lg border-2 border-gray-300 font-semibold text-gray-700 hover:bg-gray-50 transition-all duration-300",onClick:p,children:"Annuler"}),e.jsx(q,{perm:"clients.edit",fallback:null,children:e.jsx(C,{disabled:h,onClick:l,children:h?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin h-5 w-5 mr-2",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Enregistrement..."]}):"Enregistrer"})})]}),children:e.jsx("form",{onSubmit:l,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Portefeuille"}),e.jsxs("select",{className:"w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500",value:i.portfolio_id,onChange:t=>s("portfolio_id",t.target.value),required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Sélectionner..."}),m==null?void 0:m.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsx(d,{label:"Raison sociale",value:i.raison_sociale,onChange:t=>s("raison_sociale",t.target.value),required:!0}),e.jsx(d,{label:"Adresse",value:i.adresse,onChange:t=>s("adresse",t.target.value)}),e.jsx(d,{label:"RC",value:i.rc||"",onChange:t=>s("rc",t.target.value)}),e.jsx(d,{label:"IF",value:i.if||"",onChange:t=>s("if",t.target.value)}),e.jsx(d,{label:"ICE",value:i.ice||"",onChange:t=>s("ice",t.target.value)}),e.jsx(d,{label:"Forme juridique",value:i.forme_juridique,onChange:t=>s("forme_juridique",t.target.value)}),e.jsx(d,{label:"Statut juridique",value:i.statut_juridique,onChange:t=>s("statut_juridique",t.target.value)}),e.jsx(d,{label:"Date de création",type:"date",value:i.date_creation||"",onChange:t=>s("date_creation",t.target.value)}),e.jsx(d,{label:"Capital social",type:"number",step:"0.01",value:i.capital_social||"",onChange:t=>s("capital_social",t.target.value)}),e.jsx(d,{label:"Associés (JSON)",placeholder:'[{"nom":"...","parts":50}]',value:i.associes||"",onChange:t=>s("associes",t.target.value)}),e.jsx(d,{label:"Régime fiscal",value:i.regime_fiscal,onChange:t=>s("regime_fiscal",t.target.value)}),e.jsx(d,{label:"Début de collaboration",type:"date",value:i.date_debut_collaboration||"",onChange:t=>s("date_debut_collaboration",t.target.value)}),e.jsx(d,{label:"Responsable client",value:i.responsable_client,onChange:t=>s("responsable_client",t.target.value)}),e.jsx(d,{label:"Email",type:"email",value:i.email,onChange:t=>s("email",t.target.value)}),e.jsx(d,{label:"Téléphone",value:i.telephone,onChange:t=>s("telephone",t.target.value)}),e.jsx(d,{label:"Type de mission",value:i.type_mission,onChange:t=>s("type_mission",t.target.value)}),e.jsx(d,{label:"Montant contrat (€)",type:"number",step:"0.01",value:i.montant_contrat??"",onChange:t=>s("montant_contrat",t.target.value)})]})})})}function B({client:a,onClose:p}){const u=!!a,j=D(),{data:h=[],isLoading:m}=M({queryKey:["client-docs",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:n}=await y.get(`/clients/${a.id}/documents`);return n},enabled:!!(a!=null&&a.id)}),g=k({mutationFn:async({file:n,category:v,title:r,is_confidential:o})=>{const f=new FormData;f.append("file",n),v&&f.append("category",v),r&&f.append("title",r),o&&f.append("is_confidential","1");const{data:w}=await y.post(`/clients/${a.id}/documents`,f,{headers:{"Content-Type":"multipart/form-data"}});return w},onSuccess:()=>j.invalidateQueries({queryKey:["client-docs",a==null?void 0:a.id]})}),i=k({mutationFn:async n=>{await y.delete(`/clients/${a.id}/documents/${n}`)},onSuccess:()=>j.invalidateQueries({queryKey:["client-docs",a==null?void 0:a.id]})}),[c,s]=x.useState(null),[l,_]=x.useState(null),[t,S]=x.useState(""),[N,F]=x.useState(""),[$,A]=x.useState(!1);return e.jsx(R,{open:u,onClose:p,title:a?`Documents - ${a.raison_sociale}`:"Documents",footer:e.jsx("div",{className:"flex gap-3",children:e.jsx(C,{onClick:p,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Fermer"})}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-3 items-end",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Fichier"}),e.jsx("input",{type:"file",onChange:n=>{var v;return _(((v=n.target.files)==null?void 0:v[0])||null)}})]}),e.jsx("div",{children:e.jsx(d,{label:"Catégorie",value:t,onChange:n=>S(n.target.value)})}),e.jsx("div",{children:e.jsx(d,{label:"Titre",value:N,onChange:n=>F(n.target.value)})}),e.jsxs("div",{children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 mb-2",children:[e.jsx("input",{type:"checkbox",checked:$,onChange:n=>A(n.target.checked)})," ","Confidentiel"]}),e.jsx(C,{disabled:!l||g.isPending,onClick:()=>g.mutate({file:l,category:t,title:N,is_confidential:$}),children:"Téléverser"})]})]}),e.jsx("div",{className:"border-t pt-4",children:m?e.jsx("p",{className:"text-gray-500",children:"Chargement..."}):h.length===0?e.jsx("p",{className:"text-gray-500",children:"Aucun document"}):e.jsx("ul",{className:"divide-y",children:h.map(n=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-gray-800",children:n.title}),e.jsxs("p",{className:"text-xs text-gray-500",children:[n.category||"—"," · ",(n.size/1024).toFixed(1)," KB"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("a",{className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-blue-500 to-blue-600 text-white text-sm",href:`http://127.0.0.1:8002/api/clients/${a.id}/documents/${n.id}/download`,target:"_blank",rel:"noreferrer",children:"Télécharger"}),e.jsx(b.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>s(n),className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-red-500 to-red-600 text-white text-sm",children:"Supprimer"})]})]},n.id))})}),e.jsx(T,{open:!!c,title:"Supprimer le document",description:c?`Supprimer le document "${c.title}" ?`:"",onCancel:()=>s(null),onConfirm:()=>{c&&(i.mutate(c.id),s(null))}})]})})}export{V as default};
