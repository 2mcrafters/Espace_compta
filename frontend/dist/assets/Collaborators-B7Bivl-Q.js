import{e as z,R as v,j as e,m as j,d as N,M as q,g as K}from"./index-pDHLf4_7.js";import{u as F}from"./useQuery-kMVKj7Cj.js";import{u as E}from"./useMutation-CfG6Mqyy.js";import{B as b}from"./Button-CzOS0oQW.js";import{I as c}from"./Input-GRIl-wof.js";import{R as M}from"./RequirePermission-TZbtanVt.js";function O(){return F({queryKey:["users"],queryFn:async()=>{try{return(await N.get("/users")).data}catch(a){throw console.error("Error fetching users:",a),a}}})}function H(a){return F({queryKey:["user-stats",a],queryFn:async()=>{var m;try{return(await N.get(`/users/${a}/stats`)).data}catch(x){if(((m=x.response)==null?void 0:m.status)===403)return null;throw x}},enabled:!!a,retry:!1})}function Z(){var C,k;const a=z(),{data:m=[],isLoading:x,error:s}=O(),[n,o]=v.useState(null),[u,g]=v.useState(null),[l,i]=v.useState(!1),y=E({mutationFn:async({id:d,...h})=>{try{return(await N.put(`/users/${d}`,h)).data}catch(p){throw console.error("Error saving user:",p),p}},onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),o(null)},onError:d=>{var h,p;alert(`Erreur: ${((p=(h=d.response)==null?void 0:h.data)==null?void 0:p.message)||d.message||"Impossible de sauvegarder"}`)}}),w=E({mutationFn:async({id:d,hourly_rate_mad:h,effective_from:p})=>{try{return(await N.post(`/users/${d}/rate`,{hourly_rate_mad:h,effective_from:p})).data}catch(f){throw console.error("Error setting rate:",f),f}},onSuccess:()=>{a.invalidateQueries({queryKey:["users"]}),a.invalidateQueries({queryKey:["user-stats"]}),g(null)},onError:d=>{var p,f,S;const h=((p=d.response)==null?void 0:p.status)===403?"Vous n'avez pas la permission de modifier les taux horaires":((S=(f=d.response)==null?void 0:f.data)==null?void 0:S.message)||d.message||"Impossible de définir le taux";alert(`Erreur: ${h}`)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsx(j.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},children:e.jsxs("div",{className:"flex items-end justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 dark:from-gray-100 dark:to-gray-400 bg-clip-text text-transparent mb-2",children:"Collaborateurs"}),e.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Gérez vos collaborateurs et leurs informations"})]}),e.jsx(M,{perm:"users.edit",fallback:null,children:e.jsxs(b,{onClick:()=>i(!0),children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Nouvel utilisateur"]})})]})}),s&&e.jsxs(j.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl",children:[e.jsx("p",{className:"font-medium",children:"Erreur de chargement"}),e.jsx("p",{className:"text-sm",children:((k=(C=s.response)==null?void 0:C.data)==null?void 0:k.message)||s.message||"Impossible de charger les collaborateurs"})]}),x?e.jsx("div",{className:"space-y-3",children:Array.from({length:4}).map((d,h)=>e.jsx(j.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:h*.05},className:"h-20 bg-gray-200 rounded-xl animate-pulse"},h))}):e.jsx(j.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200",children:[e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Nom"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Fonction"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Email"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Téléphone"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Objectif mensuel"}),e.jsx("th",{className:"px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Taux horaire"}),e.jsx("th",{className:"px-6 py-4 text-right text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:m.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-6 py-12 text-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center text-gray-400",children:[e.jsx("svg",{className:"w-16 h-16 mb-3 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})}),e.jsx("p",{className:"font-medium",children:"Aucun collaborateur"})]})})}):m.map((d,h)=>e.jsx(P,{user:d,index:h,onEdit:()=>o(d),onSetRate:()=>g(d)},d.id))})]})})}),n&&e.jsx(Q,{user:n,onClose:()=>o(null),onSave:d=>y.mutate(d),saving:y.isPending}),u&&e.jsx(L,{user:u,onClose:()=>g(null),onSave:d=>w.mutate(d),saving:w.isPending}),l&&e.jsx(B,{onClose:()=>i(!1),onCreated:()=>{a.invalidateQueries({queryKey:["users"]}),i(!1)}})]})}function P({user:a,index:m,onEdit:x,onSetRate:s}){var g,l,i,y;const{data:n,error:o}=H(a.id),u=!o||((g=o==null?void 0:o.response)==null?void 0:g.status)!==403;return e.jsxs(j.tr,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:m*.05},whileHover:{backgroundColor:"rgba(243, 244, 246, 0.8)",scale:1.005,boxShadow:"0 4px 20px rgba(0, 0, 0, 0.05)"},className:"transition-all duration-300 relative group",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-gradient-to-br from-primary-400 to-primary-700 flex items-center justify-center text-white font-bold mr-3 shadow-lg",children:(((l=a.first_name)==null?void 0:l[0])||((i=a.last_name)==null?void 0:i[0])||((y=a.name)==null?void 0:y[0])||"U").toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-gray-900",children:a.first_name||a.last_name?`${a.first_name||""} ${a.last_name||""}`.trim():a.name}),e.jsx("div",{className:"text-xs text-gray-500",children:a.internal_id||"—"})]})]})}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:a.job_title||"—"}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:a.email}),e.jsx("td",{className:"px-6 py-4 text-gray-600",children:a.phone||"—"}),e.jsx("td",{className:"px-6 py-4",children:e.jsxs("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-blue-100 text-blue-700",children:[a.monthly_hours_target||"—"," h"]})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx(M,{perm:"users.rate",fallback:e.jsx("span",{className:"text-gray-400 text-sm",children:"•••"}),children:e.jsx("span",{className:"inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold bg-emerald-100 text-emerald-700",children:a.hourly_rate_mad?`${Number(a.hourly_rate_mad).toFixed(2)} MAD`:"—"})})}),e.jsxs("td",{className:"px-6 py-4 text-right",children:[e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(M,{perm:"users.edit",fallback:null,children:e.jsxs(j.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(75, 85, 99, 0.4)"},whileTap:{scale:.95},onClick:x,className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Modifier"})]})}),e.jsx(M,{perm:"users.rate",fallback:null,children:e.jsxs(j.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 25px rgba(99, 102, 241, 0.4)"},whileTap:{scale:.95},onClick:s,className:"px-3 py-1.5 rounded-lg bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white text-sm font-medium shadow-md transition-all duration-300 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative",children:"Taux horaire"})]})})]}),u&&e.jsxs("div",{className:"text-xs text-gray-500 mt-2",children:["Ce mois: ",(n==null?void 0:n.minutes_month)??"0"," min · Cette année:"," ",(n==null?void 0:n.minutes_year)??"0"," min"]})]})]})}function Q({user:a,onClose:m,onSave:x,saving:s}){const[n,o]=v.useState({...a});function u(l,i){o(y=>({...y,[l]:i}))}function g(){x({id:a.id,...n})}return e.jsx(q,{open:!0,onClose:m,title:`Modifier ${a.name}`,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{onClick:m,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(b,{onClick:g,disabled:s,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(c,{label:"Prénom",value:n.first_name||"",onChange:l=>u("first_name",l.target.value)}),e.jsx(c,{label:"Nom",value:n.last_name||"",onChange:l=>u("last_name",l.target.value)}),e.jsx(c,{label:"Email",value:n.email||"",onChange:l=>u("email",l.target.value)}),e.jsx(c,{label:"Téléphone",value:n.phone||"",onChange:l=>u("phone",l.target.value)}),e.jsx(c,{label:"Identifiant interne",value:n.internal_id||"",onChange:l=>u("internal_id",l.target.value)}),e.jsx(c,{label:"Fonction",value:n.job_title||"",onChange:l=>u("job_title",l.target.value)}),e.jsx(c,{label:"Objectif mensuel (h)",type:"number",step:"0.01",value:n.monthly_hours_target||"",onChange:l=>u("monthly_hours_target",l.target.value)}),e.jsx(c,{label:"Objectif annuel (h)",type:"number",step:"0.01",value:n.yearly_hours_target||"",onChange:l=>u("yearly_hours_target",l.target.value)})]})})}function L({user:a,onClose:m,onSave:x,saving:s}){const[n,o]=v.useState(""),[u,g]=v.useState(new Date().toISOString().slice(0,10));function l(){x({id:a.id,hourly_rate_mad:Number(n),effective_from:u})}return e.jsx(q,{open:!0,onClose:m,title:`Taux horaire • ${a.name}`,footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{onClick:m,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(b,{onClick:l,disabled:s||!n,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(c,{label:"Taux (MAD/h)",type:"number",step:"0.01",value:n,onChange:i=>o(i.target.value)}),e.jsx(c,{label:"Date d'effet",type:"date",value:u,onChange:i=>g(i.target.value)}),e.jsx("p",{className:"text-sm text-gray-500 md:col-span-2",children:"Seuls les rôles autorisés peuvent consulter/modifier le taux horaire."})]})})}function B({onClose:a,onCreated:m}){var k,d,h,p,f,S,R,T,$,A,D,I;z();const x=K(),[s,n]=v.useState({first_name:"",last_name:"",email:"",phone:"",internal_id:"",job_title:"",monthly_hours_target:"",yearly_hours_target:"",password:"",roles:[],hourly_rate_mad:"",hourly_rate_effective_from:new Date().toISOString().slice(0,10),send_invite:!1}),[o,u]=v.useState({}),{data:g}=F({queryKey:["roles-permissions"],queryFn:async()=>(await N.get("/roles-permissions")).data}),l=E({mutationFn:async t=>{const{data:r}=await N.post("/users",t);return r},onSuccess:()=>{x.success("Utilisateur créé avec succès"),u({}),m==null||m()},onError:t=>{var _,U;const r=t.response;(r==null?void 0:r.status)===422&&((_=r.data)!=null&&_.errors)?(u(r.data.errors||{}),x.error("Veuillez corriger les erreurs du formulaire")):(r==null?void 0:r.status)===403?x.error("Vous n'avez pas la permission de créer un utilisateur"):x.error(((U=r==null?void 0:r.data)==null?void 0:U.message)||t.message||"Impossible de créer l'utilisateur")}});function i(t,r){n(_=>({..._,[t]:r}))}function y(t){n(r=>({...r,roles:r.roles.includes(t)?r.roles.filter(_=>_!==t):[...r.roles,t]}))}function w(t){t.preventDefault(),u({});const r={...s};r.monthly_hours_target=r.monthly_hours_target===""?null:Number(r.monthly_hours_target),r.yearly_hours_target=r.yearly_hours_target===""?null:Number(r.yearly_hours_target),r.hourly_rate_mad===""&&delete r.hourly_rate_mad,r.send_invite&&r.password===""&&delete r.password,l.mutate(r)}const C=((k=g==null?void 0:g.roles)==null?void 0:k.map(t=>t.name))??[];return e.jsx(q,{open:!0,onClose:a,title:"Créer un utilisateur",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(b,{onClick:a,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(b,{onClick:w,disabled:l.isPending||!s.email||!s.send_invite&&!s.password,children:"Créer"})]}),children:e.jsxs("form",{onSubmit:w,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(c,{label:"Prénom",value:s.first_name,onChange:t=>i("first_name",t.target.value),error:(d=o.first_name)==null?void 0:d[0]}),e.jsx(c,{label:"Nom",value:s.last_name,onChange:t=>i("last_name",t.target.value),error:(h=o.last_name)==null?void 0:h[0]}),e.jsx(c,{label:"Email",type:"email",value:s.email,onChange:t=>i("email",t.target.value),required:!0,error:(p=o.email)==null?void 0:p[0]}),e.jsx(c,{label:"Mot de passe",type:"password",value:s.password,onChange:t=>i("password",t.target.value),required:!s.send_invite,disabled:s.send_invite,placeholder:s.send_invite?"Sera défini par l'invité":"",error:(f=o.password)==null?void 0:f[0]}),e.jsx(c,{label:"Téléphone",value:s.phone,onChange:t=>i("phone",t.target.value),error:(S=o.phone)==null?void 0:S[0]}),e.jsx(c,{label:"Identifiant interne",value:s.internal_id,onChange:t=>i("internal_id",t.target.value),error:(R=o.internal_id)==null?void 0:R[0]}),e.jsx(c,{label:"Fonction",value:s.job_title,onChange:t=>i("job_title",t.target.value),error:(T=o.job_title)==null?void 0:T[0]}),e.jsx(c,{label:"Objectif mensuel (h)",type:"number",step:"0.01",value:s.monthly_hours_target,onChange:t=>i("monthly_hours_target",t.target.value),error:($=o.monthly_hours_target)==null?void 0:$[0]}),e.jsx(c,{label:"Objectif annuel (h)",type:"number",step:"0.01",value:s.yearly_hours_target,onChange:t=>i("yearly_hours_target",t.target.value),error:(A=o.yearly_hours_target)==null?void 0:A[0]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx(c,{label:"Taux (MAD/h)",type:"number",step:"0.01",value:s.hourly_rate_mad,onChange:t=>i("hourly_rate_mad",t.target.value),error:(D=o.hourly_rate_mad)==null?void 0:D[0]}),e.jsx(c,{label:"Date d'effet",type:"date",value:s.hourly_rate_effective_from,onChange:t=>i("hourly_rate_effective_from",t.target.value),error:(I=o.hourly_rate_effective_from)==null?void 0:I[0]})]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700 dark:text-gray-200",children:[e.jsx("input",{type:"checkbox",checked:s.send_invite,onChange:t=>i("send_invite",t.target.checked)}),"Envoyer un email d'invitation (l'utilisateur définira son mot de passe)"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-200 mb-2",children:"Rôles"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:C.length===0?e.jsx("span",{className:"text-sm text-gray-500",children:"Chargement des rôles..."}):C.map(t=>e.jsx("button",{type:"button",onClick:()=>y(t),className:`px-3 py-1 rounded-full text-sm border ${s.roles.includes(t)?"bg-primary-600 text-white border-primary-600":"bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 border-gray-300 dark:border-gray-600"}`,children:t},t))})]})]})})}export{Z as default};
