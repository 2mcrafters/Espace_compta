import{e as $,R as y,j as e,m as u,A as R,M,d as b}from"./index-DrS59qMr.js";import{u as _}from"./useQuery-DxNF-Ufy.js";import{u as w}from"./useMutation-BqWX8doi.js";import{B as k}from"./Button-zGB7KR70.js";import{S as g}from"./Select-ZldAeqhD.js";import{R as C}from"./RequirePermission-EK-aUSRO.js";const S=[{key:"EN_ATTENTE",label:"En attente",color:"from-gray-400 to-gray-500",bgColor:"bg-gray-50",borderColor:"border-gray-200"},{key:"EN_COURS",label:"En cours",color:"from-primary-400 to-primary-700",bgColor:"bg-primary-50",borderColor:"border-primary-200"},{key:"EN_VALIDATION",label:"En validation",color:"from-amber-400 to-orange-500",bgColor:"bg-amber-50",borderColor:"border-amber-200"},{key:"TERMINEE",label:"Terminée",color:"from-emerald-400 to-green-600",bgColor:"bg-emerald-50",borderColor:"border-emerald-200"}],I=["COMPTABLE","FISCALE","SOCIALE","JURIDIQUE","AUTRE"],L=["CONTINUE","PONCTUELLE"];function H(){return _({queryKey:["tasks"],queryFn:async()=>{const{data:r}=await b.get("/tasks");return r.data??r}})}function B(){return _({queryKey:["users-lookup"],queryFn:async()=>{const{data:r}=await b.get("/users/lookup");return Array.isArray(r)?r:r.data??[]},staleTime:5*60*1e3})}function J(){const r=$(),{data:m=[],isLoading:v}=H(),{data:f=[],isLoading:N}=B(),[l,j]=y.useState({}),[c,p]=y.useState(!1),[d,t]=y.useState({category:"",nature:"",owner:""}),[o,h]=y.useState({open:!1,entryId:null,comment:""}),{data:i=[]}=_({queryKey:["clients"],queryFn:async()=>{const{data:a}=await b.get("/clients");return(a==null?void 0:a.data)??a}}),x=w({mutationFn:async a=>{const{data:s}=await b.post("/tasks",a);return s},onSuccess:()=>{r.invalidateQueries({queryKey:["tasks"]}),p(!1)},onError:a=>{var s,n;alert(`Erreur: ${((n=(s=a.response)==null?void 0:s.data)==null?void 0:n.message)||a.message||"Impossible de créer la tâche"}`)}}),E=w({mutationFn:async a=>{const{data:s}=await b.post(`/tasks/${a}/time/start`,{});return s},onSuccess:a=>{j(s=>({...s,[a.task_id]:a.id}))}}),z=w({mutationFn:async({entryId:a,comment:s})=>{const{data:n}=await b.post(`/time-entries/${a}/stop`,{comment:s});return n},onSuccess:a=>{j(s=>({...s,[a.task_id]:void 0})),h({open:!1,entryId:null,comment:""})}}),U=w({mutationFn:async({taskId:a,userId:s})=>{const{data:n}=await b.post(`/tasks/${a}/assign`,{user_id:Number(s)});return n},onSuccess:()=>{r.invalidateQueries({queryKey:["tasks"]})}});w({mutationFn:async({taskId:a,patch:s})=>{const{data:n}=await b.put(`/tasks/${a}`,s);return n},onSuccess:()=>{r.invalidateQueries({queryKey:["tasks"]})}});const A=y.useMemo(()=>{const a=m.filter(n=>!(d.category&&n.category!==d.category||d.nature&&n.nature!==d.nature||d.owner&&String(n.owner_id)!==String(d.owner))),s=Object.fromEntries(S.map(n=>[n.key,[]]));for(const n of a)s[n.status??"EN_ATTENTE"].push(n);return s},[m,d]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(u.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent mb-2",children:"Tâches"}),e.jsx("p",{className:"text-gray-600",children:"Suivez et gérez vos tâches par statut"})]}),e.jsx(C,{perm:"tasks.manage",fallback:null,children:e.jsxs(k,{onClick:()=>p(!0),children:[e.jsx("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 4v16m8-8H4"})}),"Ajouter une tâche"]})})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(g,{value:d.category,onChange:a=>t(s=>({...s,category:a.target.value})),options:[{value:"",label:"Catégorie"},...I.map(a=>({value:a,label:a}))],className:"w-40"}),e.jsx(g,{value:d.nature,onChange:a=>t(s=>({...s,nature:a.target.value})),options:[{value:"",label:"Nature"},...L.map(a=>({value:a,label:a}))],className:"w-40"}),e.jsx(g,{value:d.owner,onChange:a=>t(s=>({...s,owner:a.target.value})),options:[{value:"",label:"Responsable"},...f.map(a=>({value:String(a.id),label:a.name||a.email}))],className:"w-56"}),(d.category||d.nature||d.owner)&&e.jsx(k,{onClick:()=>t({category:"",nature:"",owner:""}),variant:"secondary",children:"Réinitialiser"})]}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:S.map((a,s)=>e.jsxs(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:s*.1},className:`rounded-2xl border-2 ${a.borderColor} ${a.bgColor} overflow-hidden shadow-lg`,children:[e.jsxs("div",{className:`bg-gradient-to-r ${a.color} px-4 py-3`,children:[e.jsx("h3",{className:"font-bold text-white text-sm uppercase tracking-wide",children:a.label}),e.jsxs("div",{className:"text-xs text-white/80 mt-0.5",children:[(A[a.key]??[]).length," tâche(s)"]})]}),e.jsx("div",{className:"p-4 space-y-3 min-h-[200px]",children:v?Array.from({length:2}).map((n,T)=>e.jsx("div",{className:"h-32 bg-white/50 rounded-xl animate-pulse"},T)):(A[a.key]??[]).length===0?e.jsxs("div",{className:"text-center py-8 text-gray-400",children:[e.jsx("svg",{className:"w-12 h-12 mx-auto mb-2 opacity-50",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})}),e.jsx("p",{className:"text-sm",children:"Aucune tâche"})]}):e.jsx(R,{children:(A[a.key]??[]).map((n,T)=>e.jsx(F,{task:n,index:T,runningEntryId:l[n.id],onStart:()=>E.mutate(n.id),onStop:()=>l[n.id]&&h({open:!0,entryId:l[n.id],comment:""}),onAssign:q=>U.mutate({taskId:n.id,userId:q}),users:f,loadingUsers:N},n.id))})})]},a.key))}),e.jsx(M,{open:o.open,onClose:()=>h({open:!1,entryId:null,comment:""}),title:"Arrêter le suivi",footer:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{className:"px-4 py-2 rounded-lg border-2 border-gray-200",onClick:()=>h({open:!1,entryId:null,comment:""}),children:"Annuler"}),e.jsx(k,{onClick:()=>z.mutate({entryId:o.entryId,comment:o.comment}),children:"Arrêter"})]}),children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Commentaire"}),e.jsx("textarea",{className:"w-full border rounded-lg p-2 min-h-[90px]",value:o.comment,onChange:a=>h(s=>({...s,comment:a.target.value})),placeholder:"Ajoutez un commentaire (optionnel)"})]})}),c&&e.jsx(W,{onClose:()=>p(!1),onSave:a=>x.mutate(a),saving:x.isPending,clients:i,users:f})]})}function F({task:r,index:m,runningEntryId:v,onStart:f,onStop:N,onAssign:l,users:j=[],loadingUsers:c=!1}){const[p,d]=y.useState(""),[t,o]=y.useState(!1),h=y.useMemo(()=>{const i=[{value:"",label:"Assigner…"}];for(const x of j){const E=x.name?`${x.name} (${x.email})`:x.email||`User #${x.id}`;i.push({value:String(x.id),label:E})}return i},[j]);return e.jsxs(u.div,{initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:-20},transition:{delay:m*.05,type:"spring",stiffness:300,damping:25},whileHover:{y:-5,scale:1.03,boxShadow:"0 20px 40px rgba(0, 0, 0, 0.12)",borderColor:"rgba(59, 130, 246, 0.3)"},onHoverStart:()=>o(!0),onHoverEnd:()=>o(!1),className:"relative rounded-xl border-2 border-gray-200 bg-white p-4 shadow-md transition-all duration-300 overflow-hidden group",children:[e.jsx(u.div,{initial:{opacity:0},animate:{opacity:t?.03:0},transition:{duration:.3},className:"absolute inset-0 bg-gradient-to-br from-primary-500 to-primary-700 pointer-events-none"}),e.jsx(u.div,{initial:{x:"-100%",opacity:0},animate:t?{x:"200%",opacity:[0,.3,0]}:{x:"-100%",opacity:0},transition:{duration:.8,ease:"easeInOut"},className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent skew-x-12 pointer-events-none"}),e.jsx("div",{className:"absolute top-0 left-0 right-0 h-1 bg-gray-100 rounded-t-xl overflow-hidden",children:e.jsx(u.div,{initial:{width:0},animate:{width:`${r.progress??0}%`},transition:{duration:1,ease:"easeOut"},className:"h-full bg-gradient-to-r from-primary-500 to-primary-700"})}),e.jsxs("div",{className:"flex items-start justify-between gap-3 mt-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-semibold text-gray-900",children:r.title??r.name??`Tâche #${r.id}`}),e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-xs",children:[e.jsxs(u.span,{whileHover:{scale:1.05,y:-1},className:"inline-flex items-center gap-1 px-2 py-1 rounded-md bg-gradient-to-r from-indigo-100 to-blue-100 text-indigo-700 font-medium border border-indigo-200 shadow-sm relative z-10",children:[e.jsx(u.svg,{animate:{rotate:t?[0,5,-5,0]:0},transition:{duration:.5},className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"})}),r.category||"Général"]}),e.jsxs(u.span,{whileHover:{scale:1.05,y:-1},className:"inline-flex items-center gap-1 px-2 py-1 rounded-md bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 font-medium border border-purple-200 shadow-sm relative z-10",children:[e.jsx("svg",{className:"w-3 h-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"})}),r.due_at??"—"]})]})]}),e.jsxs(u.div,{animate:{scale:t?1.15:1,rotate:t?[0,-3,3,0]:0},transition:{duration:.4},className:"text-sm font-bold text-primary-700 px-3 py-1.5 rounded-lg bg-gradient-to-br from-primary-50 to-primary-100 border border-primary-200 shadow-sm relative z-10",children:[r.progress??0,"%"]})]}),e.jsxs("div",{className:"mt-4 flex flex-col gap-2",children:[Array.isArray(r.assignees)&&r.assignees.length>0&&e.jsxs("div",{className:"flex -space-x-2 mb-2",children:[r.assignees.slice(0,5).map((i,x)=>e.jsx("div",{title:`${i.name||i.email}`,className:"inline-flex items-center justify-center w-7 h-7 rounded-full ring-2 ring-white bg-primary-600 text-white text-[10px] font-bold",children:P(i.name||i.email)},i.id||x)),r.assignees.length>5&&e.jsxs("div",{className:"inline-flex items-center justify-center w-7 h-7 rounded-full ring-2 ring-white bg-gray-200 text-gray-700 text-[10px] font-bold",children:["+",r.assignees.length-5]})]}),e.jsx(C,{perm:"tasks.manage",fallback:v?e.jsx("div",{className:"text-xs text-center text-red-600 py-1",children:"Pas de permission"}):e.jsx("div",{className:"text-xs text-center text-red-600 py-1",children:"Pas de permission"}),children:v?e.jsxs(u.button,{animate:{boxShadow:["0 0 0 0 rgba(244, 63, 94, 0.4)","0 0 0 8px rgba(244, 63, 94, 0)"]},transition:{duration:1.5,repeat:1/0},whileHover:{scale:1.03,y:-2,boxShadow:"0 15px 30px rgba(239, 68, 68, 0.5)"},whileTap:{scale:.97},onClick:N,className:"w-full px-3 py-2.5 rounded-lg bg-gradient-to-r from-rose-500 to-red-600 hover:from-rose-600 hover:to-red-700 text-white font-semibold shadow-lg transition-all duration-300 flex items-center justify-center gap-2 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-700"}),e.jsxs("svg",{className:"w-5 h-5 relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"})]}),e.jsx("span",{className:"relative z-10",children:"Arrêter"})]}):e.jsxs(u.button,{whileHover:{scale:1.03,y:-2,boxShadow:"0 15px 30px rgba(16, 185, 129, 0.4)"},whileTap:{scale:.97},onClick:f,className:"w-full px-3 py-2.5 rounded-lg bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white font-semibold shadow-lg transition-all duration-300 flex items-center justify-center gap-2 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-700"}),e.jsxs("svg",{className:"w-5 h-5 relative z-10",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),e.jsx("span",{className:"relative z-10",children:"Démarrer"})]})}),e.jsx(C,{perm:"tasks.manage",fallback:e.jsx("div",{className:"text-xs text-center text-red-600 py-1",children:"Pas de permission"}),children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(g,{value:p,onChange:i=>d(i.target.value),options:h,className:"flex-1 text-sm",disabled:c}),e.jsxs(u.button,{whileHover:{scale:1.05,y:-2,boxShadow:"0 10px 20px rgba(75, 85, 99, 0.4)"},whileTap:{scale:.95},onClick:()=>p&&l(p),disabled:!p,className:"px-4 py-2 rounded-lg bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white text-sm font-semibold shadow-md transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100 relative overflow-hidden group",children:[e.jsx("span",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent opacity-0 group-hover:opacity-100 transform -translate-x-full group-hover:translate-x-full transition-all duration-500"}),e.jsx("span",{className:"relative z-10",children:"OK"})]})]})}),e.jsx(C,{perm:"tasks.manage",fallback:null,children:e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(g,{value:r.status,onChange:i=>quickUpdateMutation.mutate({taskId:r.id,patch:{status:i.target.value}}),options:S.map(i=>({value:i.key,label:i.label})),className:"w-40 text-sm"}),e.jsx("input",{type:"range",min:0,max:100,value:r.progress??0,onChange:i=>quickUpdateMutation.mutate({taskId:r.id,patch:{progress:Number(i.target.value)}}),className:"flex-1"})]})})]})]})}function P(r){if(!r)return"??";const m=String(r).split(/\s+/);return m.length===1?m[0].slice(0,2).toUpperCase():(m[0][0]+m[m.length-1][0]).toUpperCase()}function W({onClose:r,onSave:m,saving:v,clients:f,users:N}){var d;const[l,j]=y.useState({client_id:((d=f[0])==null?void 0:d.id)||"",owner_id:"",category:"COMPTABLE",nature:"CONTINUE",status:"EN_ATTENTE",priority:0,progress:0,starts_at:"",due_at:"",notes:""});function c(t,o){j(h=>({...h,[t]:o}))}function p(t){t.preventDefault();const o={...l};o.owner_id||(o.owner_id=null),o.starts_at||(o.starts_at=null),o.due_at||(o.due_at=null),o.notes||(o.notes=null),m(o)}return e.jsx(M,{open:!0,onClose:r,title:"Créer une nouvelle tâche",footer:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(k,{onClick:r,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(k,{onClick:p,disabled:v||!l.client_id,children:v?"Enregistrement...":"Créer"})]}),children:e.jsxs("form",{onSubmit:p,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Client ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(g,{value:l.client_id,onChange:t=>c("client_id",t.target.value),options:[{value:"",label:"Sélectionner un client"},...f.map(t=>({value:String(t.id),label:t.raison_sociale||`Client #${t.id}`}))],required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Responsable"}),e.jsx(g,{value:l.owner_id,onChange:t=>c("owner_id",t.target.value),options:[{value:"",label:"Aucun"},...N.map(t=>({value:String(t.id),label:t.name||t.email||`User #${t.id}`}))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Catégorie ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(g,{value:l.category,onChange:t=>c("category",t.target.value),options:I.map(t=>({value:t,label:t})),required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Nature ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(g,{value:l.nature,onChange:t=>c("nature",t.target.value),options:L.map(t=>({value:t,label:t})),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Statut"}),e.jsx(g,{value:l.status,onChange:t=>c("status",t.target.value),options:S.map(t=>({value:t.key,label:t.label}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Priorité (0-5)"}),e.jsx("input",{type:"number",min:"0",max:"5",value:l.priority,onChange:t=>c("priority",parseInt(t.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Progression (0-100%)"}),e.jsx("input",{type:"number",min:"0",max:"100",value:l.progress,onChange:t=>c("progress",parseInt(t.target.value)),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date de début"}),e.jsx("input",{type:"date",value:l.starts_at,onChange:t=>c("starts_at",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date d'échéance"}),e.jsx("input",{type:"date",value:l.due_at,onChange:t=>c("due_at",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:l.notes,onChange:t=>c("notes",t.target.value),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none",placeholder:"Ajoutez des notes sur cette tâche..."})]})]})})}export{J as default};
