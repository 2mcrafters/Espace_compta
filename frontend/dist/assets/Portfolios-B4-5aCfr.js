import{e as C,R as x,j as e,m as F,M as v,C as k,d as o}from"./index-DdO7h4Wl.js";import{u as f}from"./useQuery-Y4CYsnxM.js";import{u as h}from"./useMutation-DGNKXV8s.js";import{B as n}from"./Button-8PE0XvOC.js";import{I as b}from"./Input-Da97hlJJ.js";import{R as N}from"./RequirePermission-3d12Kf4X.js";function M(){return f({queryKey:["portfolios"],queryFn:async()=>{const{data:s}=await o.get("/portfolios");return s}})}function A(){const s=C(),{data:y=[],isLoading:m}=M(),[g,d]=x.useState(!1),[r,i]=x.useState(null),[j,c]=x.useState(null),[l,a]=x.useState(null),p=h({mutationFn:async t=>{if(t.id){const{id:u,...q}=t,{data:S}=await o.put(`/portfolios/${u}`,q);return S}else{const{data:u}=await o.post("/portfolios",t);return u}},onSuccess:()=>{s.invalidateQueries({queryKey:["portfolios"]}),d(!1),i(null)}}),w=h({mutationFn:async t=>{await o.delete(`/portfolios/${t}`)},onSuccess:()=>{s.invalidateQueries({queryKey:["portfolios"]}),a(null)}});return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Portefeuilles"}),e.jsx(N,{perm:"clients.edit",fallback:null,children:e.jsx(n,{onClick:()=>{i({name:"",description:""}),d(!0)},children:"Nouveau portefeuille"})})]}),m?e.jsx("p",{children:"Chargement..."}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4",children:y.map(t=>e.jsxs(F.div,{className:"bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl p-4 shadow-sm",initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-gray-100",children:t.name}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:t.description||"—"})]}),e.jsxs("span",{className:"text-xs bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-2 py-1 rounded",children:[t.clients_count," clients"]})]}),e.jsxs("div",{className:"mt-4 flex gap-2",children:[e.jsx(n,{onClick:()=>{i(t),d(!0)},className:"!from-gray-600 !to-gray-700",children:"Modifier"}),e.jsx(n,{onClick:()=>c(t),className:"!from-blue-500 !to-blue-600",children:"Collaborateurs"}),e.jsx(N,{perm:"clients.edit",fallback:null,children:e.jsx(n,{onClick:()=>a(t),className:"!from-red-500 !to-red-600",children:"Supprimer"})})]})]},t.id))}),e.jsx(v,{open:g,onClose:()=>{d(!1),i(null)},title:r!=null&&r.id?"Modifier le portefeuille":"Nouveau portefeuille",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{onClick:()=>d(!1),className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Annuler"}),e.jsx(n,{onClick:()=>p.mutate(r),disabled:p.isPending,children:"Enregistrer"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(b,{label:"Nom",value:(r==null?void 0:r.name)||"",onChange:t=>i(u=>({...u,name:t.target.value}))}),e.jsx(b,{label:"Description",value:(r==null?void 0:r.description)||"",onChange:t=>i(u=>({...u,description:t.target.value}))})]})}),e.jsx($,{portfolio:j,onClose:()=>c(null)}),e.jsx(k,{open:!!l,title:"Supprimer le portefeuille",description:l?`Confirmez la suppression de "${l.name}". Les rattachements clients seront détachés.`:"",onCancel:()=>a(null),onConfirm:()=>l&&w.mutate(l.id)})]})}function $({portfolio:s,onClose:y}){const m=!!s,g=C(),{data:d=[]}=f({queryKey:["users-lookup"],queryFn:async()=>(await o.get("/users/lookup")).data,enabled:m}),{data:r=[]}=f({queryKey:["portfolio-collabs",s==null?void 0:s.id],queryFn:async()=>(await o.get(`/portfolios/${s.id}/collaborators`)).data,enabled:m}),i=h({mutationFn:async a=>(await o.post(`/portfolios/${s.id}/collaborators`,{user_id:a})).data,onSuccess:()=>g.invalidateQueries({queryKey:["portfolio-collabs",s==null?void 0:s.id]})}),j=h({mutationFn:async a=>(await o.delete(`/portfolios/${s.id}/collaborators/${a}`)).data,onSuccess:()=>g.invalidateQueries({queryKey:["portfolio-collabs",s==null?void 0:s.id]})}),[c,l]=x.useState(null);return e.jsxs(v,{open:m,onClose:y,title:s?`Collaborateurs • ${s.name}`:"Collaborateurs",footer:e.jsx("div",{className:"flex gap-2",children:e.jsx(n,{onClick:y,className:"!from-gray-200 !to-gray-300 !text-gray-800",children:"Fermer"})}),children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2 text-gray-900 dark:text-gray-100",children:"Tous les utilisateurs"}),e.jsx("ul",{className:"divide-y",children:d.map(a=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-800 dark:text-gray-100",children:[a.name," ",e.jsxs("span",{className:"text-gray-500 dark:text-gray-400 text-xs",children:["(",a.email,")"]})]}),e.jsx(n,{onClick:()=>i.mutate(a.id),className:"!from-blue-500 !to-blue-600",children:"Ajouter"})]},a.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2 text-gray-900 dark:text-gray-100",children:"Collaborateurs du portefeuille"}),e.jsx("ul",{className:"divide-y",children:r.map(a=>e.jsxs("li",{className:"py-2 flex items-center justify-between",children:[e.jsxs("span",{className:"text-gray-800 dark:text-gray-100",children:[a.name," ",e.jsxs("span",{className:"text-gray-500 dark:text-gray-400 text-xs",children:["(",a.email,")"]})]}),e.jsx(n,{onClick:()=>l(a),className:"!from-red-500 !to-red-600",children:"Retirer"})]},a.id))})]})]}),e.jsx(k,{open:!!c,title:"Retirer le collaborateur",description:c?`Retirer ${c.name} de ${s==null?void 0:s.name} ?`:"",onCancel:()=>l(null),onConfirm:()=>{c&&(j.mutate(c.id),l(null))}})]})}export{A as default};
